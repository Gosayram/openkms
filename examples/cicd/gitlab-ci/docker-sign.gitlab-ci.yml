# Copyright 2025 Gosayram Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# GitLab CI pipeline for signing Docker images using OpenKMS
stages:
  - build
  - sign
  - verify

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  REGISTRY: $CI_REGISTRY
  IMAGE_NAME: $CI_REGISTRY_IMAGE

before_script:
  - |
    if [ -z "$OPENKMS_URL" ] || [ -z "$OPENKMS_TOKEN" ] || [ -z "$OPENKMS_KEY_ID" ]; then
      echo "Error: OPENKMS_URL, OPENKMS_TOKEN, and OPENKMS_KEY_ID must be set"
      exit 1
    fi
  - |
    # Download OpenKMS CLI
    OPENKMS_VERSION="latest"
    wget -q "https://github.com/Gosayram/openkms/releases/${OPENKMS_VERSION}/download/openkms-cli-linux-amd64" -O openkms-cli
    chmod +x openkms-cli
    sudo mv openkms-cli /usr/local/bin/

build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - |
      docker build -t $IMAGE_NAME:$CI_COMMIT_REF_SLUG \
                   -t $IMAGE_NAME:$CI_COMMIT_SHORT_SHA \
                   .
    - docker push $IMAGE_NAME:$CI_COMMIT_REF_SLUG
    - docker push $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - |
      # Save image digest
      IMAGE_DIGEST=$(docker inspect $IMAGE_NAME:$CI_COMMIT_SHORT_SHA --format='{{index .RepoDigests 0}}' | cut -d'@' -f2)
      echo "$IMAGE_DIGEST" > image-digest.txt
      echo "IMAGE_DIGEST=$IMAGE_DIGEST" >> build.env
  artifacts:
    paths:
      - image-digest.txt
    reports:
      dotenv: build.env
  only:
    - tags
    - main
    - develop

sign:
  stage: sign
  image: alpine:latest
  dependencies:
    - build
  script:
    - apk add --no-cache wget
    - |
      # Download OpenKMS CLI
      OPENKMS_VERSION="latest"
      wget -q "https://github.com/Gosayram/openkms/releases/${OPENKMS_VERSION}/download/openkms-cli-linux-amd64" -O openkms-cli
      chmod +x openkms-cli
    - |
      # Sign image digest
      openkms-cli sign \
        --key-id "$OPENKMS_KEY_ID" \
        --file image-digest.txt \
        --server-url "$OPENKMS_URL" \
        --token "$OPENKMS_TOKEN" \
        --output image-digest.sig
    - echo "Signature created:"
    - cat image-digest.sig
  artifacts:
    paths:
      - image-digest.sig
      - image-digest.txt
    expire_in: 90 days
  only:
    - tags
    - main
    - develop

verify:
  stage: verify
  image: alpine:latest
  dependencies:
    - sign
  script:
    - apk add --no-cache wget
    - |
      # Download OpenKMS CLI
      OPENKMS_VERSION="latest"
      wget -q "https://github.com/Gosayram/openkms/releases/${OPENKMS_VERSION}/download/openkms-cli-linux-amd64" -O openkms-cli
      chmod +x openkms-cli
    - |
      # Get public key
      openkms-cli get-key "$OPENKMS_KEY_ID" \
        --server-url "$OPENKMS_URL" \
        --token "$OPENKMS_TOKEN" \
        --public-key > cosign.pub
    - |
      # Install cosign for verification
      if ! command -v cosign &> /dev/null; then
        wget -q "https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64" -O cosign
        chmod +x cosign
      fi
    - |
      # Verify signature
      ./cosign verify-blob \
        --key cosign.pub \
        --signature image-digest.sig \
        image-digest.txt
    - echo "âœ“ Signature verified successfully"
  only:
    - tags
    - main
    - develop

