// Copyright 2025 Gosayram Contributors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

// Jenkinsfile for signing artifacts using OpenKMS
pipeline {
    agent any
    
    environment {
        OPENKMS_URL = credentials('openkms-url')
        OPENKMS_TOKEN = credentials('openkms-token')
        OPENKMS_KEY_ID = credentials('openkms-key-id')
        OPENKMS_CLI_VERSION = 'latest'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Test') {
            steps {
                sh '''
                    go version
                    go test -v -race -coverprofile=coverage.out ./...
                '''
            }
            post {
                always {
                    publishCoverage adapters: [goCoverAdapter('coverage.out')]
                }
            }
        }
        
        stage('Build') {
            parallel {
                stage('Linux AMD64') {
                    steps {
                        sh '''
                            mkdir -p dist
                            GOOS=linux GOARCH=amd64 go build -o dist/myapp-linux-amd64 ./cmd/myapp
                        '''
                    }
                }
                stage('Linux ARM64') {
                    steps {
                        sh '''
                            mkdir -p dist
                            GOOS=linux GOARCH=arm64 go build -o dist/myapp-linux-arm64 ./cmd/myapp
                        '''
                    }
                }
                stage('Darwin AMD64') {
                    steps {
                        sh '''
                            mkdir -p dist
                            GOOS=darwin GOARCH=amd64 go build -o dist/myapp-darwin-amd64 ./cmd/myapp
                        '''
                    }
                }
                stage('Darwin ARM64') {
                    steps {
                        sh '''
                            mkdir -p dist
                            GOOS=darwin GOARCH=arm64 go build -o dist/myapp-darwin-arm64 ./cmd/myapp
                        '''
                    }
                }
                stage('Windows AMD64') {
                    steps {
                        sh '''
                            mkdir -p dist
                            GOOS=windows GOARCH=amd64 go build -o dist/myapp-windows-amd64.exe ./cmd/myapp
                        '''
                    }
                }
            }
        }
        
        stage('Download OpenKMS CLI') {
            steps {
                sh '''
                    wget -q "https://github.com/Gosayram/openkms/releases/${OPENKMS_CLI_VERSION}/download/openkms-cli-linux-amd64" -O openkms-cli
                    chmod +x openkms-cli
                '''
            }
        }
        
        stage('Sign Binaries') {
            steps {
                sh '''
                    # Sign all binary files
                    for binary in dist/*; do
                        if [ -f "$binary" ]; then
                            echo "Signing $binary..."
                            ./openkms-cli sign \\
                                --key-id "${OPENKMS_KEY_ID}" \\
                                --file "$binary" \\
                                --server-url "${OPENKMS_URL}" \\
                                --token "${OPENKMS_TOKEN}" \\
                                --output "${binary}.sig"
                            echo "✓ Signed: ${binary}.sig"
                        fi
                    done
                '''
            }
        }
        
        stage('Create Checksums') {
            steps {
                sh '''
                    cd dist
                    for binary in *; do
                        if [ -f "$binary" ] && [[ ! "$binary" == *.sig ]] && [[ ! "$binary" == *.sha256 ]]; then
                            shasum -a 256 "$binary" > "${binary}.sha256"
                        fi
                    done
                '''
            }
        }
        
        stage('Verify Signatures') {
            steps {
                sh '''
                    # Get public key
                    ./openkms-cli get-key "${OPENKMS_KEY_ID}" \\
                        --server-url "${OPENKMS_URL}" \\
                        --token "${OPENKMS_TOKEN}" \\
                        --public-key > cosign.pub
                    
                    # Install cosign for verification
                    if ! command -v cosign &> /dev/null; then
                        wget -q "https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64" -O cosign
                        chmod +x cosign
                    fi
                    
                    # Verify all signatures
                    FAILED=0
                    for binary in dist/*; do
                        if [ -f "$binary" ] && [[ ! "$binary" == *.sig ]] && [[ ! "$binary" == *.sha256 ]]; then
                            SIG_FILE="${binary}.sig"
                            if [ -f "$SIG_FILE" ]; then
                                echo "Verifying $binary..."
                                if ./cosign verify-blob \\
                                    --key cosign.pub \\
                                    --signature "$SIG_FILE" \\
                                    "$binary"; then
                                    echo "✓ Verified: $binary"
                                else
                                    echo "✗ Verification failed: $binary"
                                    FAILED=1
                                fi
                            else
                                echo "✗ Signature file not found: $SIG_FILE"
                                FAILED=1
                            fi
                        fi
                    done
                    
                    if [ $FAILED -eq 1 ]; then
                        exit 1
                    fi
                '''
            }
        }
        
        stage('Archive Artifacts') {
            steps {
                archiveArtifacts artifacts: 'dist/**', fingerprint: true
            }
        }
    }
    
    post {
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
        always {
            cleanWs()
        }
    }
}

